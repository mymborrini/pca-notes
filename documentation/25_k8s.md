# Prometheus and K8s

Prometheus is well suited for monitoring services in dynamic environments such as cluster schedulers. In fact, Prometheus was created specifically for this use case. Prometheus works especially well together with Kubernetes.

- Kubernetes cluster components (API Server, kubelet, etcd, DNS server) expose native Prometheus metrics endpoints
- Prometheus implements native Kubernetes-based service discovery, meaning that it can discover pods, endpoints, services, and so on, in Kubernetes clusters.

## Operational Concerns

There are a number of operational concerns to watch out for when running Prometheus on Kubernetes.

### Persistence

If you want Prometheus to keep its database between deployments, you will need to explore Kubernetes’s persistence options. For example, you may want to use a persistent volume claim (PVC) to always mount the same data volume into the Prometheus pod across restarts.

### Running Inside or Outside the cluster:

When Prometheus runs _inside_ the Kubernetes cluster, it automatically gets the right credentials mounted into its container to monitor services on Kubernetes:

1. A service account token allows Prometheus to discover cluster objects as scrape targets from the Kubernetes API Server.
2. A certificate authority (CA) file allows Prometheus to scrape metrics from secured targets like the Kubelet.
   Prometheus can also reach the service targets directly, without extra networking precautions, since its pod is part of the cluster's overlay network.

When running _outside_ of the cluster, you will need to provide Prometheus with the right credentials manually and also ensure that Prometheus can reach the metrics endpoints of services running on the Kubernetes cluster.

### RBABC

Since Kubernetes 1.7, access to the Kubernetes API Server and other components is by default heavily restricted via Kubernetes’ Role-Based Access Controls (RBAC). Prometheus needs to be run as a service account with broad read permissions to cluster resources to perform service discovery

### Prometheus Operator

As you have seen, manual operation of Prometheus and Alertmanager on Kubernetes can become complicated: you need to take care of granting sufficient permissions, mounting in persistent volumes, and performing deployments carefully.

The Prometheus Operator is an open source tool that aims to automate many of these processes using Kubernetes Custom Resource Definitions. Besides managing Prometheus servers for you, it also supports managing highly available Alertmanager clusters on top of Kubernetes. You may consider using it for operating Prometheus and Alertmanager on Kubernetes.
